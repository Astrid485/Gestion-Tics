{% extends 'layout/layout_programa.html' %}

{% block content %}
  <main class="contenido-principal">
    <!-- Mensajes de Django -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert"
          style="padding: 12px; margin: 15px 0; border-radius: 6px; font-size: 14px; border: 1px solid;
          {% if message.tags == 'success' %}  
            background-color: #d4edda; color: #155724; border-color: #c3e6cb;
          {% elif message.tags == 'error' %}
            background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;
          {% else %}
            background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb;
          {% endif %}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <!-- Formulario de búsqueda -->
    <div class="seccion-formulario">
      <form method="POST" action="{% url 'buscar_programa' %}" class="programa-busqueda-form">
        {% csrf_token %}
        <input type="text" name="programa" id="programa" placeholder="Buscar programa" class="programa-input" />
        <button type="submit" class="programa-boton">Buscar</button>
      </form>

      <!-- Tabla de resultados -->
      {% if buscar %}
      <div class="contenedor-tabla-programas">
        <table class="tabla-programas tabla-scroll">
          <thead class="table-dark">
            <tr>
              <th>Código</th>
              <th>Versión</th>
              <th>Nombre Programa</th>
              <th>Horas</th>
              <th>Área</th>
              <th>Modalidad</th>
              <th>Editar</th>
              <th>Borrar</th>
            </tr>
          </thead>
          <tbody>
            {% for programa in buscar %}
              <tr>
                <td>{{ programa.codigoprograma }}</td>
                <td>{{ programa.verision }}</td>
                <td>{{ programa.nombreprograma }}</td>
                <td>{{ programa.horas }}</td>
                <td>{{ programa.idarea.area }}</td>
                <td>{{ programa.idmodalidad.modalidad }}</td>
                <td>
                  <!-- Botón para abrir modal con datos -->
                  <button class="btn btn-sm btn-warning"
                          data-bs-toggle="modal"
                          data-bs-target="#editarModal"
                          data-codigo="{{ programa.codigoprograma }}"
                          data-version="{{ programa.verision }}"
                          data-nombre="{{ programa.nombreprograma }}"
                          data-horas="{{ programa.horas }}"
                          data-area-id="{{ programa.idarea.idarea }}"
                          data-modalidad-id="{{ programa.idmodalidad.idmodalidad }}">
                    Editar
                  </button>
                </td>
                <td>
                  <!-- Botón de borrado directo -->
                  <a href="{% url 'borrar_programa' programa.codigoprograma %}"
                     class="btn btn-sm btn-danger"
                     onclick="return confirm('¿Seguro que deseas borrar este programa?')">
                    Borrar
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="8">No se encontraron programas</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </main>

  <!-- Modal de edición -->
  <div class="modal fade" id="editarModal" tabindex="-1" aria-labelledby="editarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content modal-programa">
        <form method="POST" action="{% url 'actualizar_programa' %}">
          {% csrf_token %}
          <!-- Campo oculto para enviar el código -->
          <input type="hidden" name="codigo" id="modal-codigo-hidden" />

          <div class="modal-header modal-programa-header">
            <h5 class="modal-title" id="editarModalLabel">Editar Programa</h5>
            <button type="button" class="btn-cerrar-modal" data-bs-dismiss="modal" aria-label="Cerrar">&times;</button>
          </div>

          <div class="modal-body modal-programa-body">
            <div class="mb-3">
              <label for="codigo" class="form-label">Código</label>
              <input type="text" id="modal-codigo" class="form-control" readonly />
            </div>
            <div class="mb-3">
              <label for="version" class="form-label">Versión</label>
              <input type="text" name="version" id="modal-version" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="nombre" class="form-label">Nombre Programa</label>
              <input type="text" name="nombre" id="modal-nombre" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="horas" class="form-label">Horas</label>
              <input type="number" name="horas" id="modal-horas" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="area" class="form-label">Área</label>
              <select name="area" id="modal-area" class="form-control">
                {% for area in areas %}
                  <option value="{{ area.idarea }}">{{ area.area }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="modalidad" class="form-label">Modalidad</label>
              <select name="modalidad" id="modal-modalidad" class="form-control">
                {% for mod in modalidades %}
                  <option value="{{ mod.idmodalidad }}">{{ mod.modalidad }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="modal-footer modal-programa-footer">
            <button type="button" class="boton-cancelar-modal" data-bs-dismiss="modal">Cerrar</button>
            <button type="submit" class="boton-guardar-modal">Guardar cambios</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Script para llenar el modal -->
  <script>
    const editarModal = document.getElementById('editarModal');
    editarModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget; // Botón que abrió el modal
      const codigo = button.getAttribute('data-codigo');

      // Llenar campos básicos
      document.getElementById('modal-codigo').value = codigo;
      document.getElementById('modal-codigo-hidden').value = codigo;
      document.getElementById('modal-version').value = button.getAttribute('data-version');
      document.getElementById('modal-nombre').value = button.getAttribute('data-nombre');
      document.getElementById('modal-horas').value = button.getAttribute('data-horas');

      // Seleccionar área y modalidad por ID
      document.getElementById('modal-area').value = button.getAttribute('data-area-id');
      document.getElementById('modal-modalidad').value = button.getAttribute('data-modalidad-id');
    });
  </script>
{% endblock %}
