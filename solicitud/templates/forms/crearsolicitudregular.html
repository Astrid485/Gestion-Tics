{% extends layout %}

{% load static %}

{% block content %}
  <link rel="stylesheet" href="{% static 'css/calendario-ficha.css' %}">
  <main class="contenido-principal">
    <!-- Título -->
    <div class="titulo-seccion">
      <h2 class="titulo-pagina">FORMULARIO FICHA REGULAR</h2>
      <p class="subtitulo-pagina">Complete todos los campos requeridos para crear la solicitud de ficha</p>
    </div>

    <!-- Mensajes de Django -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert {% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% else %}info{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <!-- Formulario Principal -->
    <form class="formulario-ficha" action="{% url 'crearregular' %}" method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- Sección 1: Información del Programa -->
      <div class="seccion-formulario">
        <h3 class="titulo-seccion-form">Información del Programa</h3>

        <div class="campo-entrada">
          <label for="tieneEmpresa" class="etiqueta-campo">Tipo de oferta*:</label>
          <select id="tieneEmpresa" name="tieneEmpresa" class="entrada-select" required>
            <option value="">Seleccione una opción</option>
            <option value="no">Abierta</option>
            <option value="si">Cerrada</option>
          </select>
        </div>

        <div class="campo-entrada">
          <button type="button" class="boton-modal" onclick="abrirModal()">Filtrar y Seleccionar Programa</button>
        </div>

        <div class="campo-entrada">
          <label for="tipoPrograma" class="etiqueta-campo">Tipo de Programa*:</label>
          <input type="text" id="tipoPrograma" name="tipoPrograma" class="entrada-texto" readonly required placeholder="Seleccionar desde el modal" />
          <input type="hidden" id="tipoPrograma_id" name="tipoPrograma_id" />
        </div>

        <div class="campo-entrada">
          <label for="horasPrograma" class="etiqueta-campo">Horas del Programa*:</label>
          <input type="text" id="horasPrograma" name="horasPrograma" class="entrada-texto" readonly required />
        </div>

        <div class="campo-entrada">
          <label for="nombrePrograma" class="etiqueta-campo">Nombre del Programa*:</label>
          <input type="text" id="nombrePrograma" name="nombrePrograma" class="entrada-texto" readonly required />
          <input type="hidden" id="nombrePrograma_codigo" name="nombrePrograma_codigo" />
          <!-- Datos ocultos de programas -->
          {% for programa in programas_formacion %}
            <span class="programa-data"
                  data-codigo="{{ programa.codigoprograma }}"
                  data-area="{{ programa.idarea.idarea }}"
                  data-area-nombre="{{ programa.idarea.area }}"
                  data-horas="{{ programa.horas }}"
                  data-version="{{ programa.verision|default:'' }}"
                  data-nombre="{{ programa.nombreprograma }}"
                  style="display:none;"></span>
          {% endfor %}
        </div>

        <div class="campo-entrada">
          <label for="codigoCurso" class="etiqueta-campo">Código de Curso*:</label>
          <input type="text" id="codigoCurso" name="codigoCurso" class="entrada-texto" readonly required />
        </div>

        <div class="campo-entrada">
          <label for="versionPrograma" class="etiqueta-campo">Versión del Programa*:</label>
          <input type="text" id="versionPrograma" name="versionPrograma" class="entrada-texto" readonly required />
        </div>

        <div class="campo-entrada">
          <label for="subsectorEconomico" class="etiqueta-campo">Subsector Económico*:</label>
          <input type="text" id="subsectorEconomico" name="subsectorEconomico" class="entrada-texto" required />
        </div>
      </div>

      <!-- Sección Empresa (solo si es cerrada) -->
      <div class="seccion-formulario" id="seccionEmpresa" style="display: none;">
        <h3 class="titulo-seccion-form">Empresa y Responsable</h3>
        <div class="campo-entrada">
          <label for="empresaSolicitante" class="etiqueta-campo">Empresa Solicitante*:</label>
          <input type="text" id="empresaSolicitante" name="empresaSolicitante" class="entrada-texto" placeholder="Nombre de la empresa" />
        </div>
        <div class="campo-entrada">
          <label for="tipoEmpresa" class="etiqueta-campo">Tipo de Empresa*:</label>
          <select id="tipoEmpresa" name="tipoEmpresa" class="entrada-select">
            <option value="">Seleccione...</option>
            {% for tipo in tipos_empresas %}
              <option value="{{ tipo.idtipoempresa }}">{{ tipo.tipoempresa }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="campo-entrada">
          <label for="nombreResponsable" class="etiqueta-campo">Nombre del Responsable*:</label>
          <input type="text" id="nombreResponsable" name="nombreResponsable" class="entrada-texto" placeholder="Nombre completo" />
        </div>
        <div class="campo-entrada">
          <label for="correoResponsable" class="etiqueta-campo">Correo Electrónico*:</label>
          <input type="email" id="correoResponsable" name="correoResponsable" class="entrada-texto" placeholder="correo@empresa.com" />
        </div>
        <div class="campo-entrada">
          <label for="nitEmpresa" class="etiqueta-campo">NIT de la Empresa*:</label>
          <input type="text" id="nitEmpresa" name="nitEmpresa" class="entrada-texto" placeholder="123.456.789-0" />
        </div>
        <div class="campo-entrada">
          <label for="cartaSolicitud" class="etiqueta-campo">Carta de Solicitud (PDF)*:</label>
          <input type="file" id="cartaSolicitud" name="cartaSolicitud" accept=".pdf" required />
          <small class="texto-ayuda">Solo archivos PDF. Máximo 5MB.</small>
        </div>
      </div>

      <!-- Sección 2: Fechas -->
      <div class="seccion-formulario">
        <h3 class="titulo-seccion-form">Cupos</h3>
        <div class="campo-entrada">
          <label for="cupoAprendices" class="etiqueta-campo">Cupo de Aprendices*:</label>
          <select id="cupoAprendices" name="cupoAprendices" class="entrada-select" required>
            <option value="">Seleccione cupo</option>
            <option value="25">25</option>
            <option value="30">30</option>
          </select>
        </div>
      </div>

      <!-- Sección 3: Ubicación -->
      <div class="seccion-formulario">
        <h3 class="titulo-seccion-form">Ubicación de Formación</h3>
        <div class="campo-entrada">
          <label for="departamentoFormacion" class="etiqueta-campo">Departamento de Formación*:</label>
          <select id="departamentoFormacion" name="departamentoFormacion" class="entrada-select" required>
            <option value="">Seleccione departamento</option>
            {% for dpto in departamentos %}
              <option value="{{ dpto.codigodepartamentos }}">{{ dpto.departamentos }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="campo-entrada">
          <label for="municipioFormacion" class="etiqueta-campo">Municipio de Formación*:</label>
          <select id="municipioFormacion" name="municipioFormacion" class="entrada-select" required>
            <option value="">Primero seleccione departamento</option>
            {% for m in municipios %}
              <option value="{{ m.codigomunicipio }}"
                      data-dep="{{ m.codigodepartamento.codigodepartamentos|default:'' }}">
                {{ m.municipio }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="campo-entrada">
          <label for="direccionFormacion" class="etiqueta-campo">Dirección de Formación*:</label>
          <textarea id="direccionFormacion" name="direccionFormacion" class="entrada-textarea" rows="3" required></textarea>
        </div>
      </div>

      <!-- Sección 4: Programa Especial -->
      <div class="seccion-formulario">
        <h3 class="titulo-seccion-form">Programa Especial</h3>
        <div class="campo-entrada">
          <label for="programaEspecial" class="etiqueta-campo">Programa Especial*:</label>
          <select id="programaEspecial" name="programaEspecial" class="entrada-select" required>
            <option value="">Seleccione programa</option>
            {% for especial in programas_especiales %}
              <option value="{{ especial.idespecial }}">{{ especial.programaespecial }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="campo-entrada">
          <label for="convenio" class="etiqueta-campo">Convenio (opcional):</label>
          <input type="text" id="convenio" name="convenio" class="entrada-texto" placeholder="Nombre o número del convenio" />
        </div>
      </div>

      <!-- Sección 5: Ambiente de Formación -->
      <div class="seccion-formulario">
        <h3 class="titulo-seccion-form">Ambiente de Formación</h3>
        <div class="campo-entrada">
          <label for="nombreAmbiente" class="etiqueta-campo">Nombre del Ambiente*:</label>
          <select id="nombreAmbiente" name="nombreAmbiente" class="entrada-select" required>
            <option value="">Seleccione ambiente</option>
            {% for amb in ambientes %}
              <option value="{{ amb.idambiente }}">{{ amb.ambiente }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Sección 6: Programación del Curso -->
      <div class="seccion-formulario">
        <h3 class="titulo-seccion-form">Programación del Curso y Horario</h3>
        <div class="campo-entrada">
          <label for="fechaInicio" class="etiqueta-campo">Fecha de Inicio*:</label>
          <input type="date" id="fechaInicio" name="fechaInicio" class="entrada-texto" required />
        </div>
        <div class="campo-entrada">
          <label for="fechaFinalizacion" class="etiqueta-campo">Fecha de Finalización*:</label>
          <input type="date" id="fechaFinalizacion" name="fechaFinalizacion" class="entrada-texto" required />
        </div>
        <div class="campo-entrada">
          <label for="horarioInicio" class="etiqueta-campo">Hora de Inicio*:</label>
          <input type="time" id="horarioInicio" name="horarioInicio" class="entrada-texto" required />
        </div>
        <div class="campo-entrada">
          <label for="horarioFin" class="etiqueta-campo">Hora de Fin*:</label>
          <input type="time" id="horarioFin" name="horarioFin" class="entrada-texto" required />
        </div>
        <div class="campo-entrada">
          <label class="etiqueta-campo">Días de la Semana*:</label>
          <div class="contenedor-checkboxes">
            <label><input type="checkbox" name="diasSemana[]" value="1" onchange="generarCalendario()"> Lunes</label>
            <label><input type="checkbox" name="diasSemana[]" value="2" onchange="generarCalendario()"> Martes</label>
            <label><input type="checkbox" name="diasSemana[]" value="3" onchange="generarCalendario()"> Miércoles</label>
            <label><input type="checkbox" name="diasSemana[]" value="4" onchange="generarCalendario()"> Jueves</label>
            <label><input type="checkbox" name="diasSemana[]" value="5" onchange="generarCalendario()"> Viernes</label>
            <label><input type="checkbox" name="diasSemana[]" value="6" onchange="generarCalendario()"> Sábado</label>
            <label><input type="checkbox" name="diasSemana[]" value="0" onchange="generarCalendario()"> Domingo</label>
          </div>
        </div>

        <!-- Calendario de días específicos -->
        <div id="calendarioContainer" class="calendario-container" style="display: none;">
          <h4 class="calendario-titulo">Selecciona los días específicos del curso:</h4>
          
          <!-- Información de horas -->
          <div id="infoHoras" class="info-horas">
            <div class="resumen-horas">
              <p><strong>Horas del programa:</strong> <span id="horasTotales">-</span></p>
              <p><strong>Horas por día:</strong> <span id="horasPorDia">-</span></p>
              <p><strong>Días necesarios:</strong> <span id="diasNecesarios">-</span></p>
              <p><strong>Días seleccionados:</strong> <span id="diasMaximos">-</span></p>
            </div>
          </div>

          <div id="calendarioMeses" class="calendario-meses"></div>
          <div class="calendario-controles">
            <button type="button" onclick="seleccionarTodos(true)" class="boton-secundario">Seleccionar Todos</button>
            <button type="button" onclick="seleccionarTodos(false)" class="boton-secundario">Deseleccionar Todos</button>
          </div>
        </div>
      </div>

      <!-- Botones -->
      <div class="contenedor-botones-formulario">
        <a href="{% url 'Crearsolicitud' %}" class="boton-cancelar">Cancelar</a>
        <button type="submit" class="boton-enviar">Enviar Solicitud</button>
      </div>
    </form>

    <!-- Modal de Filtro de Programas -->
    <div id="modalFiltro" class="modal" style="display: none;">
      <div class="modal-contenido">
        <span class="cerrar-modal" onclick="cerrarModal()">&times;</span>
        <h3>Filtrar Programa de Formación</h3>

        <label for="modalArea">Área del Programa:</label>
        <select id="modalArea" class="entrada-select">
          <option value="">Todas las áreas</option>
          {% for area in areas %}
            <option value="{{ area.idarea }}">{{ area.area }}</option>
          {% endfor %}
        </select>

        <label for="modalHoras">Horas del Programa:</label>
        <select id="modalHoras" class="entrada-select">
          <option value="">Todas las horas</option>
        </select>

        <label for="modalPrograma">Programas Disponibles:</label>
        <select id="modalPrograma" size="8" class="entrada-select"></select>

        <button type="button" class="boton-seleccionar" onclick="seleccionarPrograma()">Seleccionar Programa</button>
      </div>
    </div>
  </main>

  <!-- Script Principal -->
  <script>
    // Almacenamiento de datos
    let municipiosOriginales = [];
    const programasData = [];

    // Inicialización al cargar la página
    document.addEventListener('DOMContentLoaded', function () {
      console.log("Formulario cargado correctamente");

      // Guardar opciones de municipios
      const selectMunicipio = document.getElementById('municipioFormacion');
      municipiosOriginales = Array.from(selectMunicipio.querySelectorAll('option[data-dep]'));

      // Limpiar lista inicial de municipios
      selectMunicipio.innerHTML = '<option value="">Primero seleccione departamento</option>';

      // Cargar datos de programas desde los spans ocultos
      document.querySelectorAll('.programa-data').forEach(span => {
        programasData.push({
          codigo: span.dataset.codigo,
          area: span.dataset.area,
          areaNombre: span.dataset.areaNombre,
          horas: span.dataset.horas,
          nombre: span.dataset.nombre,
          version: span.dataset.version
        });
      });

      // Eventos
      document.getElementById('departamentoFormacion').addEventListener('change', filtrarMunicipios);
      document.getElementById('tieneEmpresa').addEventListener('change', toggleEmpresa);
      document.getElementById('modalArea').addEventListener('change', filtrarProgramasModal);
      document.getElementById('modalHoras').addEventListener('change', filtrarProgramasModal);
      document.getElementById('fechaInicio').addEventListener('change', generarCalendario);
      document.getElementById('fechaFinalizacion').addEventListener('change', generarCalendario);
      
      // Eventos para horarios (regenerar calendario cuando cambien)
      document.getElementById('horarioInicio').addEventListener('change', function() {
        const horaFin = document.getElementById('horarioFin').value;
        if (horaFin && calcularHorasPorDia() <= 0) {
          this.value = '';
          return;
        }
        actualizarInfoHoras();
        generarCalendario();
      });
      
      document.getElementById('horarioFin').addEventListener('change', function() {
        const horaInicio = document.getElementById('horarioInicio').value;
        if (horaInicio && calcularHorasPorDia() <= 0) {
          this.value = '';
          return;
        }
        actualizarInfoHoras();
        generarCalendario();
      });

      // Inicializar
      llenarHorasModal();
      toggleEmpresa();
  actualizarInfoHoras();
    });

    // Filtrar municipios por departamento
    function filtrarMunicipios() {
      const dptoId = document.getElementById('departamentoFormacion').value;
      const selectMunicipio = document.getElementById('municipioFormacion');

      // Limpiar
      selectMunicipio.innerHTML = '<option value="">Seleccione municipio</option>';

      if (!dptoId) return;

      // Filtrar y agregar
      municipiosOriginales.forEach(opt => {
        if (opt.dataset.dep === dptoId) {
          const clone = opt.cloneNode(true);
          selectMunicipio.appendChild(clone);
        }
      });
    }

    // Mostrar u ocultar sección de empresa
    function toggleEmpresa() {
      const valor = document.getElementById('tieneEmpresa').value;
      const seccion = document.getElementById('seccionEmpresa');
      seccion.style.display = (valor === 'si') ? 'block' : 'none';

      // Ajustar required
      const campos = ['empresaSolicitante', 'tipoEmpresa', 'nombreResponsable', 'correoResponsable', 'nitEmpresa', 'cartaSolicitud'];
      campos.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          if (valor === 'si') {
            el.setAttribute('required', 'required');
          } else {
            el.removeAttribute('required');
          }
        }
      });
    }

    // Abrir modal
    function abrirModal() {
      document.getElementById('modalFiltro').style.display = 'block';
      filtrarProgramasModal();
    }

    // Cerrar modal
    function cerrarModal() {
      document.getElementById('modalFiltro').style.display = 'none';
    }

    // Llenar horas en modal
    function llenarHorasModal() {
      const select = document.getElementById('modalHoras');
      const horasUnicas = [...new Set(programasData.map(p => p.horas))].sort((a, b) => parseInt(a) - parseInt(b));
      
      select.innerHTML = '<option value="">Todas las horas</option>';
      horasUnicas.forEach(h => {
        const opt = document.createElement('option');
        opt.value = h;
        opt.textContent = `${h} horas`;
        select.appendChild(opt);
      });
    }

    // Filtrar programas en modal
    function filtrarProgramasModal() {
      const area = document.getElementById('modalArea').value;
      const horas = document.getElementById('modalHoras').value;
      const lista = document.getElementById('modalPrograma');

      lista.innerHTML = '';

      programasData.forEach(prog => {
        const cumpleArea = !area || prog.area === area;
        const cumpleHoras = !horas || prog.horas === horas;

        if (cumpleArea && cumpleHoras) {
          const opt = document.createElement('option');
          opt.value = prog.codigo;
          opt.textContent = prog.nombre;
          opt.dataset.area = prog.area;
          opt.dataset.areaNombre = prog.areaNombre;
          opt.dataset.horas = prog.horas;
          opt.dataset.version = prog.version || '';
          lista.appendChild(opt);
        }
      });
    }

    // Seleccionar programa del modal
    function seleccionarPrograma() {
      const lista = document.getElementById('modalPrograma');
      const selected = lista.selectedOptions[0];

      if (!selected) {
        alert('Por favor, seleccione un programa de la lista.');
        return;
      }

      // Llenar campos
      document.getElementById('tipoPrograma').value = selected.dataset.areaNombre;
      document.getElementById('tipoPrograma_id').value = selected.dataset.area;
      document.getElementById('horasPrograma').value = selected.dataset.horas + ' horas';
      document.getElementById('nombrePrograma').value = selected.textContent;
      document.getElementById('nombrePrograma_codigo').value = selected.value;
      document.getElementById('codigoCurso').value = selected.value;
      document.getElementById('versionPrograma').value = selected.dataset.version;

      cerrarModal();
  // Actualizar info de horas si ya hay horario definido
  actualizarInfoHoras();
  // Limpiar fechas seleccionadas anteriores para forzar recalculo coherente
  const checkFechas = document.querySelectorAll('input[name="fechasEspecificas[]"]:checked');
  checkFechas.forEach(c=>c.checked=false);
  generarCalendario();
    }

    // Validación antes de enviar
    document.querySelector('.formulario-ficha').addEventListener('submit', function (e) {
      const dias = document.querySelectorAll('input[name="diasSemana[]"]:checked');
      if (dias.length === 0) {
        e.preventDefault();
        alert('Debe seleccionar al menos un día de la semana.');
        return;
      }

      const programaSeleccionado = document.getElementById('nombrePrograma_codigo').value;
      if (!programaSeleccionado) {
        e.preventDefault();
        alert('Debe seleccionar un programa de formación.');
        return;
      }

      // Validar horarios
      const horasPorDia = calcularHorasPorDia();
      if (horasPorDia <= 0) {
        e.preventDefault();
        alert('Debe seleccionar horarios de inicio y fin válidos.');
        return;
      }

      // Validar que se hayan seleccionado fechas específicas
      const fechasEspecificas = document.querySelectorAll('input[name="fechasEspecificas[]"]:checked');
      if (fechasEspecificas.length === 0 && document.getElementById('calendarioContainer').style.display !== 'none') {
        e.preventDefault();
        alert('Debe seleccionar al menos una fecha específica del calendario.');
        return;
      }

      // Validar que no se excedan las horas necesarias
      const diasNecesarios = calcularDiasNecesarios();
      const diasSeleccionados = fechasEspecificas.length;
      if (diasNecesarios > 0 && diasSeleccionados !== diasNecesarios) {
        e.preventDefault();
        const horasTotales = obtenerHorasTotales();
        const diferencia = diasNecesarios - diasSeleccionados;
        const mensaje = diferencia > 0
          ? `Faltan ${diferencia} día(s) por seleccionar.`
          : `Hay ${Math.abs(diferencia)} día(s) de más seleccionados.`;
        alert(`No puede continuar.\n\nHoras del programa: ${horasTotales} horas\nHoras por día: ${horasPorDia} horas\nDías necesarios: ${diasNecesarios} días\nDías seleccionados: ${diasSeleccionados} días\n\n${mensaje}`);
        return;
      }

      // Si es oferta cerrada, validar campos de empresa
      if (document.getElementById('tieneEmpresa').value === 'si') {
        const campos = {
          'Empresa Solicitante': document.getElementById('empresaSolicitante').value.trim(),
          'Tipo de Empresa': document.getElementById('tipoEmpresa').value,
          'Nombre del Responsable': document.getElementById('nombreResponsable').value.trim(),
          'Correo Electrónico': document.getElementById('correoResponsable').value.trim(),
          'NIT de la Empresa': document.getElementById('nitEmpresa').value.trim(),
          'Carta de Solicitud': document.getElementById('cartaSolicitud').value
        };

        const faltantes = Object.keys(campos).filter(campo => !campos[campo]);
        if (faltantes.length > 0) {
          e.preventDefault();
          alert('Faltan datos obligatorios:\n- ' + faltantes.join('\n- '));
          return;
        }
      }

      // Agregar información de fechas seleccionadas al formulario
      const fechasSeleccionadas = obtenerFechasSeleccionadas();
      if (fechasSeleccionadas.length > 0) {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'fechas_calendario';
        hiddenInput.value = JSON.stringify(fechasSeleccionadas);
        this.appendChild(hiddenInput);
      }

      // Agregar información de horarios
      const hiddenHorarioInicio = document.createElement('input');
      hiddenHorarioInicio.type = 'hidden';
      hiddenHorarioInicio.name = 'horario_inicio';
      hiddenHorarioInicio.value = document.getElementById('horarioInicio').value;
      this.appendChild(hiddenHorarioInicio);

      const hiddenHorarioFin = document.createElement('input');
      hiddenHorarioFin.type = 'hidden';
      hiddenHorarioFin.name = 'horario_fin';
      hiddenHorarioFin.value = document.getElementById('horarioFin').value;
      this.appendChild(hiddenHorarioFin);
    });

    // Función para generar el calendario de días específicos
    function generarCalendario() {
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFinalizacion').value;
      const diasSeleccionados = Array.from(document.querySelectorAll('input[name="diasSemana[]"]:checked'))
                                     .map(cb => parseInt(cb.value));

      const container = document.getElementById('calendarioContainer');
      const calendarioMeses = document.getElementById('calendarioMeses');

      if (!fechaInicio || !fechaFin || diasSeleccionados.length === 0) {
        container.style.display = 'none';
        return;
      }

      const inicio = new Date(fechaInicio);
      const fin = new Date(fechaFin);

      if (inicio >= fin) {
        container.style.display = 'none';
        alert('La fecha de fin debe ser posterior a la fecha de inicio');
        return;
      }

      // Verificar si hay horarios seleccionados
      const horasPorDia = calcularHorasPorDia();
      if (horasPorDia === 0) {
        container.style.display = 'none';
        return;
      }

      // Limpiar calendario anterior
      calendarioMeses.innerHTML = '';

      // Generar calendarios por mes
      const fechaActual = new Date(inicio);
      fechaActual.setDate(1);

      while (fechaActual <= fin) {
        calendarioMeses.appendChild(generarMes(fechaActual, inicio, fin, diasSeleccionados));
        fechaActual.setMonth(fechaActual.getMonth() + 1);
      }

      container.style.display = 'block';
      
      // Actualizar información de horas
      actualizarInfoHoras();
    }

    // Función para generar calendario de un mes
    function generarMes(fecha, fechaInicio, fechaFin, diasSeleccionados) {
      const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
      const mesDiv = document.createElement('div');
      mesDiv.className = 'calendar-mes';
      mesDiv.innerHTML = `<h5>${meses[fecha.getMonth()]} ${fecha.getFullYear()}</h5>`;

      const cabecera = document.createElement('div');
      cabecera.className = 'calendar-header';
      ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'].forEach(diaTxt=>{
        const d=document.createElement('div');
        d.textContent=diaTxt;
        cabecera.appendChild(d);
      });
      mesDiv.appendChild(cabecera);

      const grid = document.createElement('div');
      grid.className = 'calendar-grid';

      const primerDia = new Date(fecha.getFullYear(), fecha.getMonth(), 1);
      const ultimoDia = new Date(fecha.getFullYear(), fecha.getMonth()+1, 0);
      
      // Espacios vacíos al inicio
      for (let i=0; i<primerDia.getDay(); i++){
        grid.appendChild(document.createElement('div'));
      }

      // Generar días del mes
      for (let dia=1; dia<=ultimoDia.getDate(); dia++) {
        const fechaDia = new Date(fecha.getFullYear(), fecha.getMonth(), dia);
        const diaSemana = fechaDia.getDay();
        const enRango = fechaDia >= fechaInicio && fechaDia <= fechaFin;
        const esSeleccion = diasSeleccionados.includes(diaSemana);
        const diaDiv = document.createElement('div');
        diaDiv.className = 'calendar-day';
        
        if (enRango && esSeleccion) {
          diaDiv.classList.add('calendar-day--selectable');
          const label = document.createElement('label');
          const checkbox = document.createElement('input');
          checkbox.type='checkbox';
          checkbox.name='fechasEspecificas[]';
          checkbox.value=fechaDia.toISOString().split('T')[0];
          checkbox.checked=true;
          
          // Event listener para validar límite de horas
          checkbox.addEventListener('change', function() {
            validarLimiteHoras();
            actualizarInfoHoras();
          });
          
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(dia));
          diaDiv.appendChild(label);
        } else {
          diaDiv.classList.add('calendar-day--disabled');
          diaDiv.textContent = dia;
        }
        grid.appendChild(diaDiv);
      }
      mesDiv.appendChild(grid);
      return mesDiv;
    }

    // Función para seleccionar/deseleccionar todos los días
    function seleccionarTodos(seleccionar) {
      document.querySelectorAll('input[name="fechasEspecificas[]"]').forEach(cb=>{cb.checked=seleccionar;cb.dispatchEvent(new Event('change'));});
    }

    // Función para obtener días seleccionados (para usar en el envío del formulario)
    function obtenerFechasSeleccionadas() {
      return Array.from(document.querySelectorAll('input[name="fechasEspecificas[]"]:checked'))
                  .map(cb => cb.value);
    }

    // Función para calcular horas por día basado en horario de inicio y fin
    function calcularHorasPorDia() {
      const horaInicio = document.getElementById('horarioInicio').value;
      const horaFin = document.getElementById('horarioFin').value;
      
      if (!horaInicio || !horaFin) return 0;

      const [horaIni, minIni] = horaInicio.split(':').map(Number);
      const [horaFinNum, minFin] = horaFin.split(':').map(Number);
      
      const inicioMinutos = horaIni * 60 + minIni;
      const finMinutos = horaFinNum * 60 + minFin;
      
      if (finMinutos <= inicioMinutos) {
        return 0;
      }
      
      return (finMinutos - inicioMinutos) / 60; // Retorna horas decimales
    }

    // Función para obtener horas totales del programa
    function obtenerHorasTotales() {
  const campo = document.getElementById('horasPrograma');
  if (!campo) return 0;
  const raw = campo.value.trim();
  if (!raw) return 0;
  // Soporta formatos como "40", "40 horas", "40h".
  const match = raw.match(/(\d+)/);
  return match ? parseInt(match[1], 10) : 0;
    }

    // Función para calcular días necesarios
    function calcularDiasNecesarios() {
      const horasTotales = obtenerHorasTotales();
      const horasPorDia = calcularHorasPorDia();
      
      if (horasPorDia === 0 || horasTotales === 0) return 0;
      
      return Math.ceil(horasTotales / horasPorDia);
    }

    // Función para actualizar información de horas (con autoajuste si excede)
    function actualizarInfoHoras() {
      const horasTotales = obtenerHorasTotales();
      const horasPorDia = calcularHorasPorDia();
      const diasNecesarios = calcularDiasNecesarios();
      let checkboxesSeleccionados = Array.from(document.querySelectorAll('input[name="fechasEspecificas[]"]:checked'));
      let diasSeleccionados = checkboxesSeleccionados.length;

      // Autoajuste: si hay más días que los necesarios y se conocen horas
      if (horasTotales > 0 && horasPorDia > 0 && diasNecesarios > 0 && diasSeleccionados > diasNecesarios) {
        const exceso = diasSeleccionados - diasNecesarios;
        // Desmarcar los últimos (fecha más reciente) para mantener las primeras fechas
        checkboxesSeleccionados
          .sort((a,b)=> b.value.localeCompare(a.value))
          .slice(0, exceso)
          .forEach(cb => { cb.checked = false; });
        // Recalcular tras el ajuste
        checkboxesSeleccionados = Array.from(document.querySelectorAll('input[name="fechasEspecificas[]"]:checked'));
        diasSeleccionados = checkboxesSeleccionados.length;
      }

      document.getElementById('horasTotales').textContent = horasTotales + ' horas';
      document.getElementById('horasPorDia').textContent = horasPorDia + ' horas';
      document.getElementById('diasNecesarios').textContent = diasNecesarios + ' días';
      document.getElementById('diasMaximos').textContent = diasSeleccionados + ' días seleccionados';

      const infoDiv = document.getElementById('infoHoras');
      infoDiv.classList.remove('estado-correcto', 'estado-exceso', 'estado-faltante');

      if (diasSeleccionados === 0 || diasNecesarios === 0 || horasTotales === 0 || horasPorDia === 0) {
        infoDiv.classList.add('estado-faltante');
        return;
      }

      if (diasSeleccionados === diasNecesarios) {
        infoDiv.classList.add('estado-correcto');
      } else if (diasSeleccionados < diasNecesarios) {
        infoDiv.classList.add('estado-faltante');
      }
    }

    // Función para validar límite de horas
    function validarLimiteHoras() {
      const diasNecesarios = calcularDiasNecesarios();
      const diasSeleccionados = document.querySelectorAll('input[name="fechasEspecificas[]"]:checked').length;
      
      if (diasSeleccionados > diasNecesarios) {
  // Silenciado: el autoajuste en actualizarInfoHoras gestionará esto.
      }
      
      return diasSeleccionados <= diasNecesarios;
    }
  </script>
{% endblock %}