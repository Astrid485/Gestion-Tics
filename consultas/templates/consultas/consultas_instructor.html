{% extends layout %}

{% block content %}
  {% comment %}Mostar esto solo al funcionario{% endcomment %}
  {% if rol == 3 %}
    <!-- Sección principal - Consultar Fichas -->
    <main class="contenido-principal">
      {% if messages %}
        {% for message in messages %}
          <div class="alert"
            style="padding: 12px; margin: 15px 0; border-radius: 6px; font-size: 14px; border: 1px solid;
                    {% if message.tags == 'success' %}
                      background-color: #d4edda; color: #155724; border-color: #c3e6cb;
            {% elif message.tags == 'error' %}
                      background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;
            {% else %}
                      background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb;
            {% endif %}">{{ message }}</div>
        {% endfor %}
      {% endif %}

      <!-- Título de la sección -->
      <div class="titulo-seccion">
        <h2 class="titulo-pagina">Consultar solicitudes {{ user }} {{ user_name }}</h2>
        <p class="subtitulo-pagina">Aquí puede consultar el estado de las fichas solicitadas y descargar los documentos correspondientes</p>
      </div>


      <!-- busqueda y filtro -->
      <!-- filtro por nombre de programa -->
      <div class="filtros-busqueda">
        <div class="filtro-nombre-programa">
          <label for="filtro-programa-funcionario">Filtrar por Nombre de Programa:</label>
          <input type="text" id="filtro-programa-funcionario" placeholder="Ingrese el nombre del programa" onkeyup="filtrarPorProgramaFuncionario()" />
        </div>
        <!-- filtro si es regular o campesena -->
        <div class="filtro-tipo-ficha">
          <label for="filtro-tipo-funcionario">Filtrar por Tipo de Ficha:</label>
          <select id="filtro-tipo-funcionario" onchange="filtrarPorTipoFuncionario()">
            <option value="">-- Todos --</option>
            <option value="Regular">Regular</option>
            <option value="Campesina">Campesina</option>
          </select>
        </div>
        <!-- filtro por fecha -->
        <div class="filtro-fecha">
          <label for="filtro-fecha">Filtrar por Fecha:</label>
          <input type="date" id="filtro-fecha" />
        </div>
      </div>

      <!-- Contenedor de la tabla de fichas -->
      <div class="contenedor-tabla-fichas">
        <table class="tabla-fichas">
          <thead>
            <tr>
              <th>Nombre del Programa</th>
              <th>Estado</th>
              <th>Codigo de la ficha</th>
              <th>Descargar ficha de caracterización</th>
              <th>Descargar documento de los aspirantes</th>
              <th>Descargar carta de solicitud</th>
              <th>Descargar formato inscripcion masivo</th>
              <th>Fecha de Creación</th>
              <th>Observación</th>
              <th>Enviar</th>
            </tr>
          </thead>
          <tbody>
            {% for solicitud_consulta in solicitudes %}
              <form action="{% url 'ficha_funcionario' solicitud_consulta.idsolicitud %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <tr data-fecha="{{ solicitud_consulta.fechasolicitud|date:'Y-m-d' }}">
                  <td>{{ solicitud_consulta.codigoprograma.nombreprograma }}</td>
                  <td>
                    <select name="estado" id="estado">
                      <option value="">-- Seleccione un estado --</option>
                      {% for item in estado %}
                        <option value="{{ item.idestado }}">{{ item.estados }}</option>
                      {% endfor %}
                    </select>
                  </td>
                  <td>
                    <input type="number" id="codigo_ficha" name="codigo_ficha" class="entrada-texto" placeholder="codigo de ficha" required />
                  </td>
                  <td>
                    <a href="{% url 'ficha_caracterizacion_pdf' solicitud_consulta.idsolicitud %}" class="boton-descargar">Descargar PDF</a>
                  </td>
                  <td>
                    <a href="{% url 'descargar_pdf' solicitud_consulta.idsolicitud rol %}" class="boton-descargar">Descargar PDF</a>
                  </td>
                  <td>
                    <a href="{% url 'descargar_carta' solicitud_consulta.idsolicitud rol %}" class="boton-descargar">Descargar Carta</a>
                  </td>
                  <td>
                    <!-- Enlace de descarga -->
                    <a href="{% url 'descargar_excel' solicitud_consulta.idsolicitud rol %}" class="link-excel" data-id="{{ solicitud_consulta.idsolicitud }}">Descargar excel</a>

                    <!-- Campo de subida -->
                    <div class="subida-reemplazo" data-id="{{ solicitud_consulta.idsolicitud }}" style="display: none;">
                      <input type="file" class="archivo-subida" name="actualizar_excel" id="actualizar_excel" data-id="{{ solicitud_consulta.idsolicitud }}" />
                    </div>
                  </td>
                  <td>{{ solicitud_consulta.fechasolicitud }}</td>
                  <td>
                    <textarea name="observacion" id="observacion" class="entrada-texto">{{ultimo_envio.observacion}}</textarea>
                  </td>
                  <td>
                    <button type="submit">Enviar</button>
                  </td>
                </tr>
              </form>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </main>

    <!-- ✅ JS SOLO PARA FUNCIONARIO -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.link-excel').forEach((enlace) => {
          const id = enlace.dataset.id
          const subida = document.querySelector(`.subida-reemplazo[data-id="${id}"]`)
          const inputArchivo = document.querySelector(`.archivo-subida[data-id="${id}"]`)
      
          // Revisamos el estado guardado en localStorage
          const estado = localStorage.getItem('estadoExcel_' + id)
      
          if (estado === 'descargado') {
            enlace.style.display = 'none'
            subida.style.display = 'block'
          } else {
            enlace.style.display = 'block'
            subida.style.display = 'none'
          }
      
          // Cuando se hace clic en el enlace (DESCARGAR)
          enlace.addEventListener('click', function () {
            enlace.style.display = 'none'
            subida.style.display = 'block'
            localStorage.setItem('estadoExcel_' + id, 'descargado')
          })
      
          // Cuando se sube un archivo
          inputArchivo.addEventListener('change', function () {
            enlace.style.display = 'block'
            subida.style.display = 'none'
            localStorage.setItem('estadoExcel_' + id, 'subido')
          })
        })
      })
      
      // Funciones de filtrado para funcionarios
      function aplicarFiltrosFuncionario() {
        const filtroPrograma = document.getElementById('filtro-programa-funcionario').value.toLowerCase()
        const filtroTipo = document.getElementById('filtro-tipo-funcionario').value
        const filtroFecha = document.getElementById('filtro-fecha').value // formato yyyy-mm-dd
        const filas = document.querySelectorAll('.tabla-fichas tbody tr')
        
        filas.forEach(fila => {
          const programa = fila.cells[0].textContent.toLowerCase()
          const fecha = fila.getAttribute('data-fecha')
          let mostrar = true

          // Programa
            if (filtroPrograma && !programa.includes(filtroPrograma)) mostrar = false
          // Tipo Regular/Campesina (se infiere del nombre del programa)
          if (filtroTipo) {
            const esCampesina = programa.includes('campesina')
            if (filtroTipo === 'Regular' && esCampesina) mostrar = false
            if (filtroTipo === 'Campesina' && !esCampesina) mostrar = false
          }
          // Fecha exacta
          if (filtroFecha && fecha !== filtroFecha) mostrar = false

          fila.style.display = mostrar ? '' : 'none'
        })
      }

      function filtrarPorProgramaFuncionario(){aplicarFiltrosFuncionario()}
      function filtrarPorTipoFuncionario(){aplicarFiltrosFuncionario()}
      document.getElementById('filtro-fecha').addEventListener('change', aplicarFiltrosFuncionario)
    </script>
  {% elif rol == 2 %}
    {% comment %}Mostrar esto solo al Coordinador{% endcomment %}
    <main class="contenido-principal">
      <!-- Título de la sección -->
      <div class="titulo-seccion">
        <h2 class="titulo-pagina">Consultar solicitudes {{ user }} {{ user_name }}</h2>
        <p class="subtitulo-pagina">Aquí puede consultar el estado de las fichas solicitadas y descargar los documentos correspondientes</p>
      </div>

      <!-- busqueda y filtro -->
      <!-- filtro por nombre de programa -->
      <div class="filtros-busqueda">
        <div class="filtro-nombre-programa">
          <label for="filtro-programa-coordinador">Filtrar por Nombre de Programa:</label>
          <input type="text" id="filtro-programa-coordinador" placeholder="Ingrese el nombre del programa" onkeyup="filtrarPorProgramaCoordinador()" />
        </div>
        <div class="filtro-tipo-ficha">
          <label for="filtro-tipo-coordinador">Filtrar por Tipo de Ficha:</label>
          <select id="filtro-tipo-coordinador" onchange="filtrarPorTipoCoordinador()">
            <option value="">-- Todos --</option>
            <option value="Regular">Regular</option>
            <option value="Campesina">Campesina</option>
          </select>
        </div>
        <div class="filtro-fecha">
          <label for="filtro-fecha-coord">Filtrar por Fecha:</label>
          <input type="date" id="filtro-fecha-coord" />
        </div>
      </div>
       
      <!-- filtro por Instructor (para funcionario, administrador y Coordinador) -->

      <!-- Contenedor de la tabla de fichas -->
      <div class="contenedor-tabla-fichas">
        <table class="tabla-fichas">
          <thead>
            <tr>
              <th>Nombre del Programa</th>
              <th>Estado</th>
              <th>Ficha de Caracterización</th>
              <th>Fecha de Creación</th>
              <th>Observación de solicitud</th>
              <th>Compartir</th>
            </tr>
          </thead>
          <tbody>
            {% for solicitud_consulta in solicitudes %}
              <tr data-fecha="{{ solicitud_consulta.fechasolicitud|date:'Y-m-d' }}">
                <form action="{% url 'ficha_funcionario' solicitud_consulta.idsolicitud %}" method="POST">
                  {% csrf_token %}
                  <td>{{ solicitud_consulta.codigoprograma.nombreprograma }}</td>
                  <td>
                    <select name="estado" id="estado">
                      <option value="">-- Seleccione un estado --</option>
                      {% for item in estado %}
                        <option value="{{ item.idestado }}">{{ item.estados }}</option>
                      {% endfor %}
                    </select>
                  </td>
                  <td>
                    <input type="number" id="codigo_ficha" name="codigo_ficha" class="entrada-texto" placeholder="codigo de ficha" required />
                  </td>
                  <td>
                    <a href="{% url 'ficha_caracterizacion_pdf' solicitud_consulta.idsolicitud %}" class="boton-descargar">Descargar PDF</a>
                  </td>
                  <td>
                    <a href="{% url 'descargar_pdf' solicitud_consulta.idsolicitud rol %}" class="boton-descargar">Descargar PDF</a>
                  </td>
                  <td>
                    <a href="{% url 'descargar_carta' solicitud_consulta.idsolicitud rol %}" class="boton-descargar">Descargar Carta</a>
                  </td>
                  <td>
                    <a href="{% url 'descargar_excel' solicitud_consulta.idsolicitud rol %}" class="link-excel">Descargar Excel</a>
                  </td>
                  <td>{{ solicitud_consulta.fechasolicitud }}</td>
                  <td>
                    <textarea name="observacion" class="entrada-texto"></textarea>
                  </td>
                  <td>
                    <button type="submit">Enviar</button>
                  </td>
                </form>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </main>
    
    <script>
      // Funciones de filtrado para coordinadores
      function aplicarFiltrosCoordinador(){
        const filtroPrograma = document.getElementById('filtro-programa-coordinador').value.toLowerCase()
        const filtroTipo = document.getElementById('filtro-tipo-coordinador').value
        const filtroFecha = document.getElementById('filtro-fecha-coord').value
        const filas = document.querySelectorAll('.tabla-fichas tbody tr')

        filas.forEach(fila => {
          const programa = fila.cells[0].textContent.toLowerCase()
          const fecha = fila.getAttribute('data-fecha')
          let mostrar = true
          if (filtroPrograma && !programa.includes(filtroPrograma)) mostrar = false
          if (filtroTipo){
            const esCampesina = programa.includes('campesina')
            if (filtroTipo === 'Regular' && esCampesina) mostrar = false
            if (filtroTipo === 'Campesina' && !esCampesina) mostrar = false
          }
            if (filtroFecha && fecha !== filtroFecha) mostrar = false
          fila.style.display = mostrar ? '' : 'none'
        })
      }
      function filtrarPorProgramaCoordinador(){aplicarFiltrosCoordinador()}
      function filtrarPorTipoCoordinador(){aplicarFiltrosCoordinador()}
      document.getElementById('filtro-fecha-coord').addEventListener('change', aplicarFiltrosCoordinador)
    </script>
  {% else %}
    {% comment %}Mostrar esto solo al Instructor/Administrador{% endcomment %}
    <main class="contenido-principal">
      <!-- Título de la sección -->
      <div class="titulo-seccion">
        <h2 class="titulo-pagina">Consultar solicitudes {{ user }} {{ user_name }}</h2>
        <p class="subtitulo-pagina">Aquí puede consultar el estado de las fichas solicitadas y descargar los documentos correspondientes</p>
      </div>

      <!-- busqueda y filtro -->
      <!-- filtro por nombre de programa -->
      <div class="filtros-busqueda">
        <div class="filtro-nombre-programa">
          <label for="filtro-programa">Filtrar por Nombre de Programa:</label>
          <input type="text" id="filtro-programa" placeholder="Ingrese el nombre del programa" onkeyup="filtrarPorPrograma()" />
        </div>
        <div class="filtro-tipo-ficha">
          <label for="filtro-tipo">Filtrar por Tipo de Ficha:</label>
          <select id="filtro-tipo" onchange="filtrarPorTipo()">
            <option value="">-- Todos --</option>
            <option value="Regular">Regular</option>
            <option value="Campesina">Campesina</option>
          </select>
        </div>
        <div class="filtro-fecha">
          <label for="filtro-fecha-general">Filtrar por Fecha:</label>
          <input type="date" id="filtro-fecha-general" />
        </div>
      </div>

      <!-- Contenedor de la tabla de fichas -->
      <div class="contenedor-tabla-fichas">
        <table class="tabla-fichas">
          <thead>
            <tr>
              <th>Nombre del Programa</th>
              <th>Estado</th>
              <th>Observación dada por el funcionario</th>
              <th>Ficha de Caracterización</th>
              <th>Documentos de Aprendices</th>
              <th>Excel sofia plus</th>
              <th>Fecha de Creación</th>
              <th>Compartir</th>
            </tr>
          </thead>
          <tbody>
            {% for solicitud_consulta in solicitudes %}
              <tr data-fecha="{{ solicitud_consulta.fechasolicitud|date:'Y-m-d' }}">
                <td>{{ solicitud_consulta.codigoprograma.nombreprograma }}</td>
                <td>
                  {% if solicitud_consulta.estado_usuario %}
                      {% if solicitud_consulta.estado_usuario == "Matriculada" %}
                          <span class="estado-aprobado">{{ solicitud_consulta.estado_usuario }}</span>
                      {% elif solicitud_consulta.estado_usuario == "Rechazada" %}
                          <span class="estado-rechazado">{{ solicitud_consulta.estado_usuario }}</span>
                      {% elif solicitud_consulta.estado_usuario == "Creada" %}
                          <span class="estado-creada">{{ solicitud_consulta.estado_usuario }}</span>
                      {% elif solicitud_consulta.estado_usuario == "Creacion" %}
                          <span class="estado estado-creacion">{{ solicitud_consulta.estado_usuario }}</span>
                      {% endif %}
                  {% else %}
                      <span class="estado-espera">Lista de espera</span>
                  {% endif %}
                </td>
                <td>
                  {% if solicitud_consulta.observacion_usuario %}
                      {{ solicitud_consulta.observacion_usuario }}
                  {% else %}
                      Sin observación
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'ficha_caracterizacion' solicitud_consulta.idsolicitud %}" class="boton-descargar">Ver ficha Caracterización</a>
                </td>
                <td>
                  {% if solicitud_consulta.aspirantes %}
                    {{ solicitud_consulta.aspirantes|length }} aspirante{{ solicitud_consulta.aspirantes|length|pluralize }}
                  {% else %}
                    Sin aspirantes
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'sofia_plus_descarga' solicitud_consulta.idsolicitud %}" class="boton-descargar">Descargar excel</a>
                </td> 
                <td>{{ solicitud_consulta.fechasolicitud }}</td>
                <td>
                  <button onclick="document.getElementById('modal-{{ solicitud_consulta.idsolicitud }}').style.display='block'" class="boton-compartir">Compartir</button>
                </td>
              </tr>

              <!-- Modal único para cada solicitud -->
              <div id="modal-{{ solicitud_consulta.idsolicitud }}" class="modal-compartir" style="display: none;">
                <div class="contenido-modal">
                  <div class="encabezado-modal">
                    <h3>Compartir Ficha</h3>
                    <button onclick="document.getElementById('modal-{{ solicitud_consulta.idsolicitud }}').style.display='none'" class="boton-cerrar-modal">&times;</button>
                  </div>

                  <div class="cuerpo-modal">
                    <p class="programa-seleccionado">Programa: {{ solicitud_consulta.codigoprograma.nombreprograma }}</p>

                    <!-- ✅ Enlace con href correcto -->
                    <div class="opcion-compartir">
                      <h4>Compartir con enlace</h4>
                      <div class="grupo-link">
                        <a href="{% url 'formularioaspirantes' solicitud_consulta.idsolicitud %}">https://preinscripcion/{{ codigo }}</a>
                      </div>
                    </div>

                    <div class="separador-modal">
                      <span>O</span>
                    </div>

                    <!-- Lista de aspirantes -->
                    <div class="opcion-compartir">
                      <h4>Ver aspirantes Inscritos</h4>
                      <div class="resultados-busqueda">
                        {% for aspirante in solicitud_consulta.aspirantes %}
                          <div class="item-aprendiz">
                            <div class="info-aprendiz">
                              <span class="nombre-aprendiz">{{ aspirante.nombre }} {{ aspirante.apellido }}</span>
                              <span class="documento-aprendiz">{{ aspirante.tipoidentificacion.tipoidentificacion }} {{ aspirante.numeroidentificacion }}</span>
                              <span class="documento-aprendiz">Teléfono: {{ aspirante.telefono }}</span>
                              <span class="documento-aprendiz">Correo: {{ aspirante.correo }}</span>
                            </div>
                          </div>
                        {% empty %}
                          <div class="item-aprendiz">
                            <div class="info-aprendiz">
                              <span class="nombre-aprendiz">No hay aspirantes registrados para esta ficha</span>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>

                  <!-- Pie modal -->
                  <div class="pie-modal">
                    <button onclick="document.getElementById('modal-{{ solicitud_consulta.idsolicitud }}').style.display='none'" class="boton-cancelar">Cancelar</button>
                    <button class="boton-compartir-modal">Compartir</button>
                  </div>
                </div>
              </div>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </main>
    
    <script>
      // Funciones de filtrado para instructores/administradores
      function filtrarPorPrograma() {
        const filtro = document.getElementById('filtro-programa').value.toLowerCase()
        const filas = document.querySelectorAll('.tabla-fichas tbody tr')
        
        filas.forEach(fila => {
          const programa = fila.cells[0].textContent.toLowerCase()
          if (programa.includes(filtro)) {
            fila.style.display = ''
          } else {
            fila.style.display = 'none'
          }
        })
      }
      
      function filtrarPorTipo() {
        const filtro = document.getElementById('filtro-tipo').value
        const filas = document.querySelectorAll('.tabla-fichas tbody tr')
        
        filas.forEach(fila => {
          const programa = fila.cells[0].textContent
          if (filtro === '') {
            fila.style.display = ''
          } else if (filtro === 'Regular' && !programa.toLowerCase().includes('campesina')) {
            fila.style.display = ''
          } else if (filtro === 'Campesina' && programa.toLowerCase().includes('campesina')) {
            fila.style.display = ''
          } else {
            fila.style.display = 'none'
          }
        })
      }
      
      // Función combinada que aplica ambos filtros
      function aplicarFiltros() {
        const filtroPrograma = document.getElementById('filtro-programa').value.toLowerCase()
        const filtroTipo = document.getElementById('filtro-tipo').value
        const filtroFecha = document.getElementById('filtro-fecha-general').value
        const filas = document.querySelectorAll('.tabla-fichas tbody tr')
        
        filas.forEach(fila => {
          const programa = fila.cells[0].textContent.toLowerCase()
          const fecha = fila.getAttribute('data-fecha')
          let mostrarFila = true
          
          if (filtroPrograma && !programa.includes(filtroPrograma)) mostrarFila = false
          if (filtroTipo) {
            const esCampesina = programa.includes('campesina')
            if (filtroTipo === 'Regular' && esCampesina) mostrarFila = false
            if (filtroTipo === 'Campesina' && !esCampesina) mostrarFila = false
          }
          if (filtroFecha && fecha !== filtroFecha) mostrarFila = false
          fila.style.display = mostrarFila ? '' : 'none'
        })
      }
      
      // Actualizar las funciones individuales para usar la función combinada
      function filtrarPorPrograma() {
        aplicarFiltros()
      }
      
      function filtrarPorTipo() {
        aplicarFiltros()
      }
      document.getElementById('filtro-fecha-general').addEventListener('change', aplicarFiltros)
    </script>
  {% endif %}
{% endblock %}
